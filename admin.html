<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị - Niceng</title>
    <link rel="icon" type="image/svg+xml" href="https://learnenglishwithaurora.github.io/aurora.svg" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            font-family: 'Inter', system-ui, Avenir, Helvetica, Arial, sans-serif;
            line-height: 1.5;
            font-weight: 400;
            color-scheme: light;
            color: #333;
            background-color: #f8f9fa;
            font-synthesis: none;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 40px;
            filter: brightness(0) invert(1);
        }

        .logo h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .user-info span:hover {
            background-color: rgba(255,255,255,0.2);
        }

        #content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom: 3px solid #FFA500;
            color: #FFA500;
        }

        .tab:hover {
            color: #FFA500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #FFA500;
        }

        .card h3 {
            margin-top: 0;
            color: #333;
            margin-bottom: 15px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-danger {
            background: #ff4d4d;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3333;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

        .btn-info:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #e68a00;
            transform: translateY(-2px);
        }

        form {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #FFD700;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #FFA500;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin: 0;
            color: #FFA500;
        }

        .stat-label {
            margin: 10px 0 0;
            color: #666;
            font-size: 14px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .item-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .user-card {
            border-left: 4px solid #2196F3;
        }

        .category-card {
            border-left: 4px solid #4CAF50;
        }

        .system-card {
            border-left: 4px solid #FFC107;
        }

        .user-vocab-card {
            border-left: 4px solid #9C27B0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .vocab-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .vocab-filter select, .vocab-filter input {
            flex: 1;
            min-width: 200px;
        }

        .vocab-stats {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .vocab-stat-item {
            background: #f0f0f0;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .vocab-stat-item.need-to-know {
            background: #2196F3;
            color: white;
        }

        .vocab-stat-item.known {
            background: #4CAF50;
            color: white;
        }

        .vocab-stat-item.mastered {
            background: #FF9800;
            color: white;
        }

        .user-banned {
            background-color: #ffebee !important;
        }

        .user-banned h3 {
            color: #c62828;
        }

        .banned-badge {
            background: #ff4d4d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .admin-badge {
            background: #FFA500;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-learning {
            background: #2196F3;
            color: white;
        }

        .status-known {
            background: #4CAF50;
            color: white;
        }

        .status-mastered {
            background: #FF9800;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            min-width: 40px;
        }

        .pagination button.active {
            background: #FFA500;
            color: white;
        }

        /* Analytics Styles - Lấy từ trang chủ */
        .analytics-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .analytics-header h2 {
            color: #333;
            font-size: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }

        .progress-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .progress-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .progress-item .label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .progress-item .value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .progress-item .change {
            font-size: 12px;
            margin-top: 5px;
        }

        .progress-item .change.positive {
            color: #4CAF50;
        }

        .progress-item .change.negative {
            color: #f44336;
        }

        .evaluation {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .evaluation.excellent {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .evaluation.good {
            background: #E3F2FD;
            color: #1565C0;
        }

        .evaluation.average {
            background: #FFF8E1;
            color: #FF8F00;
        }

        .evaluation.poor {
            background: #FFEBEE;
            color: #C62828;
        }

        .evaluation h3 {
            margin-bottom: 10px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .tab {
                padding: 10px 15px;
                border-bottom: 1px solid #e0e0e0;
                border-left: 3px solid transparent;
            }

            .tab.active {
                border-bottom: 1px solid #e0e0e0;
                border-left: 3px solid #FFA500;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }

            .card-actions {
                flex-direction: column;
            }

            .card-actions button {
                width: 100%;
            }

            table {
                display: block;
                overflow-x: auto;
            }

            .vocab-filter {
                flex-direction: column;
            }

            .vocab-filter select, .vocab-filter input {
                width: 100%;
                min-width: unset;
            }

            .progress-summary {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            #top-bar {
                padding: 10px 15px;
            }

            .logo h1 {
                font-size: 18px;
            }

            #content {
                padding: 15px;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .stat-number {
                font-size: 28px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="top-bar">
            <div class="logo">
                <img src="https://learnenglishwithaurora.github.io/aurora.svg" alt="Niceng">
                <h1>Niceng - Quản trị</h1>
            </div>
            <div class="user-info">
                <a href="main.html" class="material-symbols-outlined" title="Về trang chính">home</a>
                <span id="logout" class="material-symbols-outlined" title="Đăng xuất">logout</span>
            </div>
        </div>

        <div id="content">
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">Tổng quan</div>
                <div class="tab" data-tab="categories">Chủ đề</div>
                <div class="tab" data-tab="cards">Thẻ từ vựng</div>
                <div class="tab" data-tab="users">Người dùng</div>
                <div class="tab" data-tab="vocabulary">Từ vựng người dùng</div>
                <!-- THÊM TAB MỚI -->
                <div class="tab" data-tab="analytics">Đánh giá & Tổng kết</div>
            </div>

            <div id="dashboard" class="tab-content active">
                <h2>Tổng quan hệ thống</h2>
                <div class="stats">
                    <div class="stat-card">
                        <p class="stat-number" id="total-users">0</p>
                        <p class="stat-label">Tổng người dùng</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="total-cards">0</p>
                        <p class="stat-label">Tổng thẻ từ vựng</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="total-categories">0</p>
                        <p class="stat-label">Tổng chủ đề</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="active-today">0</p>
                        <p class="stat-label">Người dùng hoạt động hôm nay</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="banned-users">0</p>
                        <p class="stat-label">Người dùng bị khóa</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="total-user-vocab">0</p>
                        <p class="stat-label">Tổng từ vựng người dùng</p>
                    </div>
                </div>
            </div>

            <div id="categories" class="tab-content">
                <h2>Quản lý chủ đề</h2>
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-name">Tên chủ đề</label>
                        <input type="text" id="category-name" required placeholder="Ví dụ: Động vật, Thực phẩm, Du lịch...">
                    </div>
                    <div class="form-group">
                        <label for="category-description">Mô tả</label>
                        <textarea id="category-description" placeholder="Mô tả ngắn về chủ đề..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="category-icon">URL biểu tượng (tùy chọn)</label>
                        <input type="text" id="category-icon" placeholder="https://example.com/icon.svg">
                    </div>
                    <button type="submit" class="btn-primary">Thêm chủ đề</button>
                </form>

                <div id="categories-list" class="items-grid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <div id="cards" class="tab-content">
                <h2>Quản lý thẻ từ vựng hệ thống</h2>
                <form id="card-form">
                    <div class="form-group">
                        <label for="card-word">Từ tiếng Anh</label>
                        <input type="text" id="card-word" required placeholder="Ví dụ: apple">
                    </div>
                    <div class="form-group">
                        <label for="card-meaning">Nghĩa tiếng Việt</label>
                        <input type="text" id="card-meaning" required placeholder="Ví dụ: quả táo">
                    </div>
                    <div class="form-group">
                        <label for="card-example">Ví dụ (tiếng Anh)</label>
                        <input type="text" id="card-example" placeholder="Ví dụ: I eat an apple every day.">
                    </div>
                    <div class="form-group">
                        <label for="card-category">Chủ đề</label>
                        <select id="card-category" required>
                            <option value="">Chọn chủ đề</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Thêm thẻ</button>
                </form>

                <div id="cards-list" class="items-grid">
                    <!-- Cards will be loaded here -->
                </div>
            </div>

            <div id="users" class="tab-content">
                <h2>Quản lý người dùng</h2>
                <div id="users-list" class="items-grid">
                    <!-- Users will be loaded here -->
                </div>
            </div>

            <div id="vocabulary" class="tab-content">
                <h2>Theo dõi từ vựng người dùng</h2>
                
                <div class="vocab-filter">
                    <select id="vocab-user-filter">
                        <option value="">Tất cả người dùng</option>
                    </select>
                    <select id="vocab-status-filter">
                        <option value="">Tất cả trạng thái</option>
                        <option value="learning">Từ đang học (learning)</option>
                        <option value="known">Từ đã biết (known)</option>
                        <option value="mastered">Từ đã thuộc (mastered)</option>
                    </select>
                    <input type="text" id="vocab-search" placeholder="Tìm kiếm từ vựng...">
                    <button id="refresh-vocab" class="btn-primary">Làm mới</button>
                </div>

                <div id="vocab-stats-container">
                    <!-- Vocabulary statistics will be loaded here -->
                </div>

                <div id="vocabulary-list">
                    <!-- User vocabulary will be loaded here -->
                </div>

                <div id="vocab-pagination" class="pagination">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>

            <!-- TAB MỚI: ĐÁNH GIÁ VÀ TỔNG KẾT -->
            <div id="analytics" class="tab-content">
                <h2>Đánh giá và Tổng kết Tất cả Người dùng</h2>
                
                <!-- Bộ lọc ĐƠN GIẢN - CHỈ CÓ 1 SELECT -->
                <div class="card">
                    <h3>Bộ lọc dữ liệu</h3>
                    <div class="vocab-filter">
                        <select id="analytics-user-filter">
                            <option value="">Tất cả người dùng</option>
                            <option value="top-10">Top 10 người dùng tích cực</option>
                        </select>
                    </div>
                </div>

                <!-- Thống kê tổng quan -->
                <div class="stats">
                    <div class="stat-card">
                        <p class="stat-number" id="total-active-users">0</p>
                        <p class="stat-label">Người dùng có hoạt động</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="total-learned">0</p>
                        <p class="stat-label">Tổng từ đã học</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="total-mastered">0</p>
                        <p class="stat-label">Tổng từ đã thuộc</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-number" id="avg-per-user">0</p>
                        <p class="stat-label">Trung bình/người dùng</p>
                    </div>
                </div>

                <!-- Biểu đồ tổng quan -->
                <div class="analytics-section">
                    <div class="analytics-header">
                        <h2>Biểu đồ tiến độ tổng hợp</h2>
                        <span id="analytics-date-range">Tất cả thời gian</span>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="overall-progress-chart"></canvas>
                    </div>
                </div>

                <!-- Biểu đồ phân phối người dùng -->
                <div class="analytics-section">
                    <div class="analytics-header">
                        <h2>Phân phối người dùng theo nhóm tiến độ</h2>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="user-distribution-chart"></canvas>
                    </div>
                    
                    <div class="progress-summary">
                        <div class="progress-item">
                            <div class="label">Người dùng mới bắt đầu (0-10 từ)</div>
                            <div class="value" id="beginner-users">0</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Người dùng trung bình (11-50 từ)</div>
                            <div class="value" id="intermediate-users">0</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Người dùng tích cực (51-200 từ)</div>
                            <div class="value" id="advanced-users">0</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Người dùng xuất sắc (201+ từ)</div>
                            <div class="value" id="expert-users">0</div>
                        </div>
                    </div>
                </div>

                <!-- Bảng xếp hạng người dùng -->
                <div class="analytics-section">
                    <h3>Bảng xếp hạng người dùng tích cực</h3>
                    <div id="user-ranking-table">
                        <!-- Bảng xếp hạng sẽ được tải ở đây -->
                        <p>Đang tải dữ liệu...</p>
                    </div>
                </div>

                <!-- Đánh giá tổng thể -->
                <div class="analytics-section">
                    <div class="evaluation" id="overall-evaluation">
                        <h3>Đánh giá tổng thể hệ thống</h3>
                        <p>Chưa có đủ dữ liệu để đánh giá</p>
                    </div>
                </div>

                <!-- Chi tiết từng người dùng (mở rộng) -->
                <div class="analytics-section">
                    <h3>Chi tiết từng người dùng</h3>
                    <div id="user-details-list">
                        <!-- Danh sách chi tiết sẽ được tải ở đây -->
                        <p>Chọn một người dùng để xem chi tiết</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing user vocabulary details -->
    <div id="vocab-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Chi tiết từ vựng</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div id="modal-body">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBc55gGulDbOCgGp2USL_HXeVLwqqXFTTU",
            authDomain: "niceng-c235d.firebaseapp.com",
            projectId: "niceng-c235d",
            storageBucket: "niceng-c235d.firebasestorage.app",
            messagingSenderId: "532991375524",
            appId: "1:532991375524:web:699b2e9f5b1bf727d68e31",
            measurementId: "G-PDZ20PLN86"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentAdminId = null;
        let currentPage = 1;
        const itemsPerPage = 20;
        let totalVocabItems = 0;
        let allVocabItems = [];
        let allUsers = {};
        let analyticsData = {};
        let overallProgressChart = null;
        let userDistributionChart = null;

        // Check if user is admin
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentAdminId = user.uid;
                // Check if user is admin
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().role === 'admin') {
                        // Load admin data
                        loadDashboard();
                        loadCategories();
                        loadCards();
                        loadUsers();
                        // Không load từ vựng tự động, chỉ khi click tab
                    } else {
                        // Redirect to main page if not admin
                        window.location.href = 'main.html';
                    }
                });
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
            }
        });

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
                
                // Nếu click vào tab từ vựng thì load từ vựng
                if (tab.getAttribute('data-tab') === 'vocabulary') {
                    loadUserVocabulary();
                }
                // Nếu click vào tab analytics thì load đánh giá
                if (tab.getAttribute('data-tab') === 'analytics') {
                    loadAnalyticsData();
                }
            });
        });

        // Load dashboard statistics
        function loadDashboard() {
            // Total users
            db.collection('users').get().then(snapshot => {
                document.getElementById('total-users').textContent = snapshot.size;
                
                // Count banned users
                let bannedCount = 0;
                snapshot.forEach(doc => {
                    if (doc.data().banned === true) {
                        bannedCount++;
                    }
                });
                document.getElementById('banned-users').textContent = bannedCount;
                
                // Active users today (simplified - in a real app, you'd track login activity)
                document.getElementById('active-today').textContent = snapshot.size;
            });
            
            // Total categories
            db.collection('categories').get().then(snapshot => {
                document.getElementById('total-categories').textContent = snapshot.size;
            });
            
            // Total system cards
            db.collection('systemCards').get().then(snapshot => {
                document.getElementById('total-cards').textContent = snapshot.size;
            });
            
            // Load total user vocabulary count
            loadTotalUserVocabularyCount();
        }

        // Load total user vocabulary count
        function loadTotalUserVocabularyCount() {
            db.collection('users').get().then(usersSnapshot => {
                let totalCount = 0;
                let userCount = 0;
                const totalUsers = usersSnapshot.size;
                
                if (totalUsers === 0) {
                    document.getElementById('total-user-vocab').textContent = 0;
                    return;
                }
                
                usersSnapshot.forEach(userDoc => {
                    db.collection('users').doc(userDoc.id).collection('cards').get()
                        .then(cardsSnapshot => {
                            totalCount += cardsSnapshot.size;
                            userCount++;
                            
                            if (userCount === totalUsers) {
                                document.getElementById('total-user-vocab').textContent = totalCount;
                            }
                        })
                        .catch(() => {
                            userCount++;
                            if (userCount === totalUsers) {
                                document.getElementById('total-user-vocab').textContent = totalCount;
                            }
                        });
                });
            });
        }

        // Load categories
        function loadCategories() {
            const categoriesList = document.getElementById('categories-list');
            categoriesList.innerHTML = '';
            
            db.collection('categories').get().then(snapshot => {
                if (snapshot.empty) {
                    categoriesList.innerHTML = '<div class="card"><p>Chưa có chủ đề nào.</p></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const category = doc.data();
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'item-card category-card';
                    categoryElement.innerHTML = `
                        <h3>${category.name}</h3>
                        <p>${category.description || 'Không có mô tả'}</p>
                        <div class="card-actions">
                            <button class="btn-danger delete-category" data-id="${doc.id}">Xóa</button>
                        </div>
                    `;
                    categoriesList.appendChild(categoryElement);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-category').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const categoryId = e.target.getAttribute('data-id');
                        if (confirm('Bạn có chắc chắn muốn xóa chủ đề này? Tất cả thẻ từ vựng trong chủ đề này cũng sẽ bị xóa.')) {
                            deleteCategory(categoryId);
                        }
                    });
                });
                
                // Populate category dropdown for cards
                const categoryDropdown = document.getElementById('card-category');
                categoryDropdown.innerHTML = '<option value="">Chọn chủ đề</option>';
                snapshot.forEach(doc => {
                    const category = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = category.name;
                    categoryDropdown.appendChild(option);
                });
            });
        }

        // Add new category
        document.getElementById('category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('category-name').value;
            const description = document.getElementById('category-description').value;
            const icon = document.getElementById('category-icon').value;
            
            db.collection('categories').add({
                name: name,
                description: description,
                icon: icon,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                document.getElementById('category-form').reset();
                loadCategories();
                loadDashboard();
                showAlert('Đã thêm chủ đề mới thành công!', 'success');
            })
            .catch((error) => {
                console.error('Error adding category: ', error);
                showAlert('Có lỗi xảy ra khi thêm chủ đề!', 'error');
            });
        });

        // Delete category
        function deleteCategory(categoryId) {
            // First delete all cards in this category
            db.collection('systemCards')
                .where('categoryId', '==', categoryId)
                .get()
                .then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    // Then delete the category
                    return db.collection('categories').doc(categoryId).delete();
                })
                .then(() => {
                    loadCategories();
                    loadDashboard();
                    loadCards();
                    showAlert('Đã xóa chủ đề và tất cả thẻ liên quan!', 'success');
                })
                .catch((error) => {
                    console.error('Error deleting category: ', error);
                    showAlert('Có lỗi xảy ra khi xóa chủ đề!', 'error');
                });
        }

        // Load cards
        function loadCards() {
            const cardsList = document.getElementById('cards-list');
            cardsList.innerHTML = '';
            
            db.collection('systemCards').get().then(snapshot => {
                if (snapshot.empty) {
                    cardsList.innerHTML = '<div class="card"><p>Chưa có thẻ từ vựng nào.</p></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const card = doc.data();
                    const cardElement = document.createElement('div');
                    cardElement.className = 'item-card system-card';
                    cardElement.innerHTML = `
                        <h3>${card.word} - ${card.meaning}</h3>
                        ${card.example ? `<p><strong>Ví dụ:</strong> ${card.example}</p>` : ''}
                        <p><strong>Chủ đề:</strong> ${card.categoryName || 'Không có'}</p>
                        <div class="card-actions">
                            <button class="btn-danger delete-card" data-id="${doc.id}">Xóa</button>
                        </div>
                    `;
                    cardsList.appendChild(cardElement);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-card').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const cardId = e.target.getAttribute('data-id');
                        if (confirm('Bạn có chắc chắn muốn xóa thẻ này?')) {
                            deleteCard(cardId);
                        }
                    });
                });
            });
        }

        // Add new card
        document.getElementById('card-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const word = document.getElementById('card-word').value;
            const meaning = document.getElementById('card-meaning').value;
            const example = document.getElementById('card-example').value;
            const categoryId = document.getElementById('card-category').value;
            const categoryName = document.getElementById('card-category').options[document.getElementById('card-category').selectedIndex].text;
            
            db.collection('systemCards').add({
                word: word,
                meaning: meaning,
                example: example,
                categoryId: categoryId,
                categoryName: categoryName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                document.getElementById('card-form').reset();
                loadCards();
                loadDashboard();
                showAlert('Đã thêm thẻ từ vựng mới thành công!', 'success');
            })
            .catch((error) => {
                console.error('Error adding card: ', error);
                showAlert('Có lỗi xảy ra khi thêm thẻ từ vựng!', 'error');
            });
        });

        // Delete card
        function deleteCard(cardId) {
            db.collection('systemCards').doc(cardId).delete()
                .then(() => {
                    loadCards();
                    loadDashboard();
                    showAlert('Đã xóa thẻ từ vựng!', 'success');
                })
                .catch((error) => {
                    console.error('Error deleting card: ', error);
                    showAlert('Có lỗi xảy ra khi xóa thẻ từ vựng!', 'error');
            });
        }

        // Load users
        function loadUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            allUsers = {};
            
            db.collection('users').get().then(snapshot => {
                if (snapshot.empty) {
                    usersList.innerHTML = '<div class="card"><p>Chưa có người dùng nào.</p></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userId = doc.id;
                    const isBanned = user.banned === true;
                    const isAdmin = user.role === 'admin';
                    const isCurrentUser = userId === currentAdminId;
                    
                    // Lưu vào allUsers để sử dụng sau
                    allUsers[userId] = user;
                    
                    const userElement = document.createElement('div');
                    userElement.className = `item-card user-card ${isBanned ? 'user-banned' : ''}`;
                    userElement.innerHTML = `
                        <h3>${user.name || 'Không có tên'} 
                            ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}
                            ${isBanned ? '<span class="banned-badge">ĐÃ KHÓA</span>' : ''}
                        </h3>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Vai trò:</strong> ${isAdmin ? 'Quản trị viên' : 'Người dùng'}</p>
                        <p><strong>Ngày tham gia:</strong> ${user.createdAt ? user.createdAt.toDate().toLocaleDateString('vi-VN') : 'Không rõ'}</p>
                        <p><strong>ID:</strong> <small>${userId}</small></p>
                        <div class="card-actions">
                            ${!isAdmin ? 
                                `<button class="btn-success make-admin" data-id="${userId}">Thành admin</button>` : 
                                (!isCurrentUser ? `<button class="btn-danger remove-admin" data-id="${userId}" data-name="${user.name || user.email}">Bỏ admin</button>` : '<button class="btn-warning" disabled>Bạn đang đăng nhập</button>')
                            }
                            ${!isCurrentUser ? 
                                (!isBanned ? 
                                    `<button class="btn-danger ban-user" data-id="${userId}" data-email="${user.email}">Khóa tài khoản</button>` :
                                    `<button class="btn-success unban-user" data-id="${userId}" data-email="${user.email}">Mở khóa</button>`
                                ) : ''
                            }
                            <button class="btn-info view-vocab" data-id="${userId}" data-name="${user.name || user.email}">Xem từ vựng</button>
                            <button class="btn-info view-analytics" data-id="${userId}" data-name="${user.name || user.email}">Xem đánh giá</button>
                        </div>
                    `;
                    usersList.appendChild(userElement);
                });
                
                // Add event listeners to role buttons
                document.querySelectorAll('.make-admin').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-id');
                        if (confirm('Bạn có chắc chắn muốn cấp quyền admin cho người dùng này?')) {
                            updateUserRole(userId, 'admin');
                        }
                    });
                });
                
                document.querySelectorAll('.remove-admin').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-id');
                        const userName = e.target.getAttribute('data-name');
                        if (confirm(`Bạn có chắc chắn muốn BỎ quyền admin của ${userName}?`)) {
                            updateUserRole(userId, 'user');
                        }
                    });
                });
                
                // Add event listeners to ban buttons
                document.querySelectorAll('.ban-user').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-id');
                        const userEmail = e.target.getAttribute('data-email');
                        if (confirm(`Bạn có chắc chắn muốn KHÓA tài khoản ${userEmail}?\n\nNgười dùng sẽ không thể đăng nhập và phải đăng ký lại để sử dụng web.`)) {
                            banUser(userId, true);
                        }
                    });
                });
                
                document.querySelectorAll('.unban-user').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-id');
                        const userEmail = e.target.getAttribute('data-email');
                        if (confirm(`Bạn có chắc chắn muốn MỞ KHÓA tài khoản ${userEmail}?`)) {
                            banUser(userId, false);
                        }
                    });
                });
                
                // Add event listeners to view vocabulary buttons
                document.querySelectorAll('.view-vocab').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-id');
                        const userName = e.target.getAttribute('data-name');
                        // Switch to vocabulary tab and filter by user
                        document.querySelector('[data-tab="vocabulary"]').click();
                        document.getElementById('vocab-user-filter').value = userId;
                        loadUserVocabulary(userId);
                        showAlert(`Đang hiển thị từ vựng của: ${userName}`, 'success');
                    });
                });
                
                // Add event listeners to view analytics buttons
                document.querySelectorAll('.view-analytics').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-id');
                        const userName = e.target.getAttribute('data-name');
                        // Switch to analytics tab and show user-specific analytics
                        document.querySelector('[data-tab="analytics"]').click();
                        document.getElementById('analytics-user-filter').value = userId;
                        loadAnalyticsData(userId);
                        showAlert(`Đang hiển thị đánh giá của: ${userName}`, 'success');
                    });
                });
                
                // Populate user filter in vocabulary tab
                const userFilter = document.getElementById('vocab-user-filter');
                userFilter.innerHTML = '<option value="">Tất cả người dùng</option>';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${user.name || 'Không tên'} (${user.email}) ${user.role === 'admin' ? '- ADMIN' : ''}`;
                    userFilter.appendChild(option);
                });
                
                // Populate user filter in analytics tab - CHỈ GIỮ LẠI 2 TÙY CHỌN
                const analyticsUserFilter = document.getElementById('analytics-user-filter');
                analyticsUserFilter.innerHTML = '<option value="">Tất cả người dùng</option>';
                analyticsUserFilter.innerHTML += '<option value="top-10">Top 10 người dùng tích cực</option>';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (!user.banned) { // Chỉ hiển thị người dùng không bị khóa
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = `${user.name || 'Không tên'} (${user.email})`;
                        analyticsUserFilter.appendChild(option);
                    }
                });
            });
        }

        // Update user role
        function updateUserRole(userId, role) {
            db.collection('users').doc(userId).update({
                role: role
            })
            .then(() => {
                loadUsers();
                showAlert(`Đã cập nhật vai trò người dùng thành ${role === 'admin' ? 'quản trị viên' : 'người dùng'}!`, 'success');
            })
            .catch((error) => {
                console.error('Error updating user role: ', error);
                showAlert('Có lỗi xảy ra khi cập nhật vai trò!', 'error');
            });
        }

        // Ban or unban user
        function banUser(userId, ban) {
            db.collection('users').doc(userId).update({
                banned: ban,
                bannedAt: ban ? firebase.firestore.FieldValue.serverTimestamp() : null
            })
            .then(() => {
                loadUsers();
                loadDashboard();
                showAlert(ban ? `Đã khóa tài khoản người dùng! Người dùng sẽ không thể đăng nhập.` : `Đã mở khóa tài khoản người dùng!`, 'success');
            })
            .catch((error) => {
                console.error('Error banning user: ', error);
                showAlert('Có lỗi xảy ra khi thao tác với tài khoản!', 'error');
            });
        }

        // Load user vocabulary
        function loadUserVocabulary(userId = null) {
            const vocabList = document.getElementById('vocabulary-list');
            const statsContainer = document.getElementById('vocab-stats-container');
            vocabList.innerHTML = '<div class="card"><p>Đang tải từ vựng...</p></div>';
            statsContainer.innerHTML = '';
            
            // Lấy tất cả người dùng nếu chưa có
            if (Object.keys(allUsers).length === 0) {
                db.collection('users').get().then(snapshot => {
                    snapshot.forEach(doc => {
                        allUsers[doc.id] = doc.data();
                    });
                    loadAllUserVocabulary(userId);
                });
            } else {
                loadAllUserVocabulary(userId);
            }
        }

        // Load tất cả từ vựng từ tất cả người dùng
        function loadAllUserVocabulary(userId = null) {
            if (Object.keys(allUsers).length === 0) {
                console.error('Không có dữ liệu người dùng');
                return;
            }
            
            const vocabPromises = [];
            const userIds = userId ? [userId] : Object.keys(allUsers);
            
            userIds.forEach(userId => {
                vocabPromises.push(
                    db.collection('users').doc(userId).collection('cards').get()
                        .then(snapshot => {
                            const userVocab = [];
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                userVocab.push({
                                    id: doc.id,
                                    userId: userId,
                                    ...data
                                });
                            });
                            return userVocab;
                        })
                        .catch(error => {
                            console.error(`Error loading vocab for user ${userId}:`, error);
                            return [];
                        })
                );
            });
            
            Promise.all(vocabPromises).then(allResults => {
                // Gộp tất cả kết quả
                allVocabItems = allResults.flat();
                totalVocabItems = allVocabItems.length;
                
                if (totalVocabItems === 0) {
                    document.getElementById('vocabulary-list').innerHTML = '<div class="card"><p>Không có từ vựng nào trong hệ thống.</p></div>';
                    return;
                }
                
                console.log(`Đã tìm thấy ${totalVocabItems} từ vựng từ ${userIds.length} người dùng`);
                
                // Áp dụng bộ lọc và hiển thị
                applyFiltersAndDisplay();
            });
        }

        // Áp dụng bộ lọc và hiển thị
        function applyFiltersAndDisplay() {
            const statusFilter = document.getElementById('vocab-status-filter').value;
            const searchFilter = document.getElementById('vocab-search').value.toLowerCase();
            const userFilter = document.getElementById('vocab-user-filter').value;
            
            let filteredVocab = allVocabItems;
            
            // Lọc theo user
            if (userFilter) {
                filteredVocab = filteredVocab.filter(item => item.userId === userFilter);
            }
            
            // Lọc theo trạng thái
            if (statusFilter) {
                filteredVocab = filteredVocab.filter(item => {
                    const status = item.status || 'learning';
                    return status === statusFilter;
                });
            }
            
            // Lọc theo tìm kiếm
            if (searchFilter) {
                filteredVocab = filteredVocab.filter(item => {
                    const word = item.word || '';
                    const meaning = item.meaning || '';
                    const example = item.example || '';
                    
                    return word.toLowerCase().includes(searchFilter) || 
                           meaning.toLowerCase().includes(searchFilter) ||
                           example.toLowerCase().includes(searchFilter);
                });
            }
            
            // Tính thống kê
            const stats = {
                total: filteredVocab.length,
                learning: 0,
                known: 0,
                mastered: 0
            };
            
            filteredVocab.forEach(item => {
                const status = item.status || 'learning';
                if (stats[status] !== undefined) {
                    stats[status]++;
                } else {
                    stats.learning++; // Mặc định là learning nếu không có status
                }
            });
            
            // Hiển thị thống kê
            displayStatistics(stats);
            
            // Hiển thị bảng với phân trang
            displayVocabTable(filteredVocab);
        }

        // Hiển thị thống kê
        function displayStatistics(stats) {
            const statsContainer = document.getElementById('vocab-stats-container');
            statsContainer.innerHTML = `
                <div class="vocab-stats">
                    <div class="vocab-stat-item">Tổng: ${stats.total}</div>
                    <div class="vocab-stat-item need-to-know">Đang học: ${stats.learning}</div>
                    <div class="vocab-stat-item known">Đã biết: ${stats.known}</div>
                    <div class="vocab-stat-item mastered">Đã thuộc: ${stats.mastered}</div>
                </div>
                <p><small>Tìm thấy ${totalVocabItems} từ vựng trong hệ thống</small></p>
            `;
        }

        // Hiển thị bảng từ vựng với phân trang
        function displayVocabTable(vocabItems) {
            const vocabList = document.getElementById('vocabulary-list');
            const totalPages = Math.ceil(vocabItems.length / itemsPerPage);
            
            // Tính chỉ số bắt đầu và kết thúc
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = vocabItems.slice(startIndex, endIndex);
            
            if (pageItems.length === 0) {
                vocabList.innerHTML = '<div class="card"><p>Không có từ vựng nào phù hợp với bộ lọc.</p></div>';
                document.getElementById('vocab-pagination').innerHTML = '';
                return;
            }
            
            // Tạo bảng
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Người dùng</th>
                            <th>Từ tiếng Anh</th>
                            <th>Nghĩa tiếng Việt</th>
                            <th>Trạng thái</th>
                            <th>Chủ đề</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pageItems.forEach(item => {
                const user = allUsers[item.userId];
                const status = item.status || 'learning';
                
                // Chuyển đổi status sang text
                const statusText = {
                    'learning': 'Đang học',
                    'known': 'Đã biết',
                    'mastered': 'Đã thuộc'
                }[status] || status;
                
                const statusClass = {
                    'learning': 'status-learning',
                    'known': 'status-known',
                    'mastered': 'status-mastered'
                }[status] || '';
                
                const createdAt = item.createdAt ? 
                    item.createdAt.toDate ? 
                    item.createdAt.toDate().toLocaleDateString('vi-VN') : 
                    new Date(item.createdAt).toLocaleDateString('vi-VN') : 
                    'Không rõ';
                
                tableHTML += `
                    <tr>
                        <td>${user ? (user.name || user.email) : (item.userId)}</td>
                        <td><strong>${item.word || 'Không có'}</strong></td>
                        <td>${item.meaning || 'Không có'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${item.category || 'Không có'}</td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn-info view-vocab-detail" data-userid="${item.userId}" data-vocabid="${item.id}">Chi tiết</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            vocabList.innerHTML = tableHTML;
            
            // Hiển thị phân trang
            displayPagination(totalPages);
            
            // Thêm sự kiện cho nút chi tiết
            document.querySelectorAll('.view-vocab-detail').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userId = e.target.getAttribute('data-userid');
                    const vocabId = e.target.getAttribute('data-vocabid');
                    showVocabDetail(userId, vocabId);
                });
            });
        }

        // Hiển thị phân trang
        function displayPagination(totalPages) {
            const paginationContainer = document.getElementById('vocab-pagination');
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Nút đầu
            if (currentPage > 1) {
                const firstButton = document.createElement('button');
                firstButton.textContent = '«';
                firstButton.addEventListener('click', () => {
                    currentPage = 1;
                    applyFiltersAndDisplay();
                });
                paginationContainer.appendChild(firstButton);
            }
            
            // Nút trước
            if (currentPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = '<';
                prevButton.addEventListener('click', () => {
                    currentPage--;
                    applyFiltersAndDisplay();
                });
                paginationContainer.appendChild(prevButton);
            }
            
            // Các số trang
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    applyFiltersAndDisplay();
                });
                paginationContainer.appendChild(pageButton);
            }
            
            // Nút sau
            if (currentPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = '>';
                nextButton.addEventListener('click', () => {
                    currentPage++;
                    applyFiltersAndDisplay();
                });
                paginationContainer.appendChild(nextButton);
            }
            
            // Nút cuối
            if (currentPage < totalPages) {
                const lastButton = document.createElement('button');
                lastButton.textContent = '»';
                lastButton.addEventListener('click', () => {
                    currentPage = totalPages;
                    applyFiltersAndDisplay();
                });
                paginationContainer.appendChild(lastButton);
            }
        }

        // Show vocabulary detail in modal
        function showVocabDetail(userId, vocabId) {
            db.collection('users').doc(userId).collection('cards').doc(vocabId).get()
                .then(vocabDoc => {
                    if (!vocabDoc.exists) return;
                    
                    const vocab = vocabDoc.data();
                    const user = allUsers[userId];
                    
                    const modal = document.getElementById('vocab-modal');
                    const modalBody = document.getElementById('modal-body');
                    
                    const status = vocab.status || 'learning';
                    const statusText = {
                        'learning': 'Đang học',
                        'known': 'Đã biết',
                        'mastered': 'Đã thuộc'
                    }[status] || status;
                    
                    const statusClass = {
                        'learning': 'status-learning',
                        'known': 'status-known',
                        'mastered': 'status-mastered'
                    }[status] || '';
                    
                    const createdAt = vocab.createdAt ? 
                        vocab.createdAt.toDate ? 
                        vocab.createdAt.toDate().toLocaleString('vi-VN') : 
                        new Date(vocab.createdAt).toLocaleString('vi-VN') : 
                        'Không rõ';
                    
                    modalBody.innerHTML = `
                        <div class="card">
                            <h3>${vocab.word || 'Không có'} - ${vocab.meaning || 'Không có'}</h3>
                            <p><strong>Người dùng:</strong> ${user ? (user.name || user.email) : userId}</p>
                            <p><strong>Trạng thái:</strong> <span class="status-badge ${statusClass}">${statusText}</span></p>
                            <p><strong>Ngày tạo:</strong> ${createdAt}</p>
                            ${vocab.example ? `<p><strong>Ví dụ:</strong> ${vocab.example}</p>` : ''}
                            ${vocab.category ? `<p><strong>Chủ đề:</strong> ${vocab.category}</p>` : ''}
                            <p><strong>ID từ vựng:</strong> <small>${vocabId}</small></p>
                            <p><strong>ID người dùng:</strong> <small>${userId}</small></p>
                            <div class="card-actions">
                                <button class="btn-danger delete-vocab-admin" data-userid="${userId}" data-vocabid="${vocabId}">Xóa từ vựng này</button>
                            </div>
                        </div>
                    `;
                    
                    modal.style.display = 'block';
                    
                    // Thêm sự kiện cho nút xóa
                    document.querySelector('.delete-vocab-admin').addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-userid');
                        const vocabId = e.target.getAttribute('data-vocabid');
                        const word = vocab.word || 'từ vựng này';
                        
                        if (confirm(`Bạn có chắc chắn muốn xóa từ "${word}" của người dùng này?`)) {
                            deleteUserVocabulary(userId, vocabId);
                        }
                    });
                });
        }

        // Xóa từ vựng của người dùng
        function deleteUserVocabulary(userId, vocabId) {
            db.collection('users').doc(userId).collection('cards').doc(vocabId).delete()
                .then(() => {
                    showAlert('Đã xóa từ vựng của người dùng!', 'success');
                    document.getElementById('vocab-modal').style.display = 'none';
                    
                    // Cập nhật lại danh sách
                    const currentUserId = document.getElementById('vocab-user-filter').value;
                    loadUserVocabulary(currentUserId || null);
                    loadTotalUserVocabularyCount();
                })
                .catch((error) => {
                    console.error('Error deleting user vocabulary:', error);
                    showAlert('Có lỗi xảy ra khi xóa từ vựng!', 'error');
                });
        }

        // ================== CHỨC NĂNG ĐÁNH GIÁ VÀ TỔNG KẾT ==================

        // Load analytics data
        function loadAnalyticsData(userId = null) {
            document.getElementById('user-details-list').innerHTML = '<div class="card"><p>Đang tải dữ liệu đánh giá...</p></div>';
            document.getElementById('user-ranking-table').innerHTML = '<p>Đang tải bảng xếp hạng...</p>';
            
            analyticsData = {};
            
            // Lấy tất cả người dùng
            db.collection('users').get().then(usersSnapshot => {
                const users = [];
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (!userData.banned) { // Chỉ lấy người dùng không bị khóa
                        users.push({
                            id: doc.id,
                            ...userData
                        });
                    }
                });
                
                analyticsData.users = users;
                analyticsData.totalUsers = users.length;
                
                // Lấy dữ liệu từ vựng của tất cả người dùng
                loadAllUserVocabForAnalytics(userId);
            });
        }

        // Load tất cả từ vựng của người dùng cho đánh giá
        function loadAllUserVocabForAnalytics(userId = null) {
            const users = analyticsData.users;
            const userStats = {};
            
            // Khởi tạo thống kê
            analyticsData.totalLearned = 0;
            analyticsData.totalMastered = 0;
            analyticsData.activeUsers = 0;
            
            if (users.length === 0) {
                updateAnalyticsUI();
                return;
            }
            
            // Lấy từ vựng của mỗi người dùng
            const promises = [];
            
            users.forEach(user => {
                // Xử lý filter top-10
                if (userId === 'top-10') {
                    // Chúng ta sẽ xử lý sau khi có tất cả dữ liệu
                } else if (userId && user.id !== userId) {
                    return; // Bỏ qua nếu không phải người dùng được chọn
                }
                
                promises.push(
                    db.collection('users').doc(user.id).collection('cards').get()
                        .then(snapshot => {
                            const userVocab = {
                                total: 0,
                                learning: 0,
                                known: 0,
                                mastered: 0,
                                words: []
                            };
                            
                            snapshot.forEach(doc => {
                                const card = doc.data();
                                userVocab.total++;
                                userVocab.words.push(card);
                                
                                const status = card.status || 'learning';
                                if (status === 'learning') userVocab.learning++;
                                else if (status === 'known') userVocab.known++;
                                else if (status === 'mastered') userVocab.mastered++;
                            });
                            
                            userStats[user.id] = {
                                userInfo: user,
                                vocab: userVocab,
                                learnedTotal: userVocab.known + userVocab.mastered,
                                masteredTotal: userVocab.mastered,
                                activityLevel: calculateActivityLevel(userVocab.total, userVocab.mastered)
                            };
                            
                            // Cập nhật tổng số
                            if (userVocab.total > 0) analyticsData.activeUsers++;
                            analyticsData.totalLearned += userVocab.known + userVocab.mastered;
                            analyticsData.totalMastered += userVocab.mastered;
                        })
                );
            });
            
            Promise.all(promises).then(() => {
                analyticsData.userStats = userStats;
                
                // Xử lý filter top-10
                if (userId === 'top-10') {
                    filterTop10Users();
                }
                
                // Lấy dữ liệu lịch sử học tập cho biểu đồ
                loadLearningHistoryForAnalytics(userId);
            });
        }

        // Filter top 10 users
        function filterTop10Users() {
            const userStats = analyticsData.userStats;
            if (!userStats) return;
            
            // Sắp xếp người dùng theo điểm số
            const sortedUsers = Object.entries(userStats).sort((a, b) => {
                const scoreA = a[1].vocab.mastered * 3 + a[1].vocab.known * 2 + a[1].vocab.learning;
                const scoreB = b[1].vocab.mastered * 3 + b[1].vocab.known * 2 + b[1].vocab.learning;
                return scoreB - scoreA;
            });
            
            // Chỉ giữ lại top 10
            const top10UserIds = sortedUsers.slice(0, 10).map(entry => entry[0]);
            
            // Lọc chỉ giữ lại top 10 trong userStats
            const filteredUserStats = {};
            top10UserIds.forEach(userId => {
                if (userStats[userId]) {
                    filteredUserStats[userId] = userStats[userId];
                }
            });
            
            analyticsData.userStats = filteredUserStats;
            
            // Cập nhật lại tổng số
            analyticsData.activeUsers = Object.keys(filteredUserStats).length;
            analyticsData.totalLearned = 0;
            analyticsData.totalMastered = 0;
            
            Object.values(filteredUserStats).forEach(userStat => {
                analyticsData.totalLearned += userStat.vocab.known + userStat.vocab.mastered;
                analyticsData.totalMastered += userStat.vocab.mastered;
            });
        }

        // Load lịch sử học tập - TỰ ĐỘNG LẤY 30 NGÀY GẦN NHẤT
        function loadLearningHistoryForAnalytics(userId = null) {
            const users = analyticsData.users;
            const today = new Date();
            
            // Tạo mảng 30 ngày gần nhất
            const last30Days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last30Days.push(date.toISOString().split('T')[0]);
            }
            
            analyticsData.dailyData = {
                labels: last30Days.map(date => {
                    const d = new Date(date);
                    return d.getDate() + '/' + (d.getMonth() + 1);
                }),
                learnedData: new Array(30).fill(0),
                masteredData: new Array(30).fill(0)
            };
            
            // Lấy lịch sử học tập của mỗi người dùng
            const historyPromises = [];
            
            const usersToProcess = userId === 'top-10' 
                ? Object.values(analyticsData.userStats).map(stat => stat.userInfo)
                : analyticsData.users;
            
            usersToProcess.forEach(user => {
                if (userId && userId !== 'top-10' && user.id !== userId) return;
                
                last30Days.forEach((date, index) => {
                    historyPromises.push(
                        db.collection('users').doc(user.id).collection('learningHistory').doc(date).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const data = doc.data();
                                    analyticsData.dailyData.learnedData[index] += data.learnedToday || 0;
                                    analyticsData.dailyData.masteredData[index] += data.masteredToday || 0;
                                }
                            })
                    );
                });
            });
            
            Promise.all(historyPromises).then(() => {
                // Phân loại người dùng theo nhóm tiến độ
                classifyUsersByProgress();
                
                // Cập nhật giao diện
                updateAnalyticsUI();
                
                // Tạo biểu đồ
                createCharts();
            });
        }

        // Phân loại người dùng theo tiến độ
        function classifyUsersByProgress() {
            const userStats = analyticsData.userStats;
            analyticsData.userGroups = {
                beginner: 0,    // 0-10 từ
                intermediate: 0, // 11-50 từ
                advanced: 0,    // 51-200 từ
                expert: 0       // 201+ từ
            };
            
            for (const userId in userStats) {
                const totalWords = userStats[userId].vocab.total;
                
                if (totalWords <= 10) {
                    analyticsData.userGroups.beginner++;
                } else if (totalWords <= 50) {
                    analyticsData.userGroups.intermediate++;
                } else if (totalWords <= 200) {
                    analyticsData.userGroups.advanced++;
                } else {
                    analyticsData.userGroups.expert++;
                }
            }
        }

        // Tính toán mức độ hoạt động
        function calculateActivityLevel(totalWords, masteredWords) {
            if (totalWords === 0) return 'Không hoạt động';
            if (totalWords >= 200) return 'Xuất sắc';
            if (totalWords >= 50) return 'Tích cực';
            if (totalWords >= 10) return 'Trung bình';
            return 'Bắt đầu';
        }

        // Cập nhật giao diện đánh giá
        function updateAnalyticsUI() {
            // Cập nhật thống kê tổng quan
            document.getElementById('total-active-users').textContent = analyticsData.activeUsers || 0;
            document.getElementById('total-learned').textContent = analyticsData.totalLearned || 0;
            document.getElementById('total-mastered').textContent = analyticsData.totalMastered || 0;
            
            const avgPerUser = analyticsData.activeUsers > 0 ? 
                Math.round((analyticsData.totalLearned + analyticsData.totalMastered) / analyticsData.activeUsers) : 0;
            document.getElementById('avg-per-user').textContent = avgPerUser;
            
            // Cập nhật phân phối người dùng
            document.getElementById('beginner-users').textContent = analyticsData.userGroups?.beginner || 0;
            document.getElementById('intermediate-users').textContent = analyticsData.userGroups?.intermediate || 0;
            document.getElementById('advanced-users').textContent = analyticsData.userGroups?.advanced || 0;
            document.getElementById('expert-users').textContent = analyticsData.userGroups?.expert || 0;
            
            // Tạo bảng xếp hạng
            createUserRankingTable();
            
            // Tạo danh sách chi tiết người dùng
            createUserDetailsList();
            
            // Đánh giá tổng thể
            evaluateOverallProgress();
        }

        // Tạo bảng xếp hạng người dùng
        function createUserRankingTable() {
            const userStats = analyticsData.userStats;
            if (!userStats) {
                document.getElementById('user-ranking-table').innerHTML = '<p>Không có dữ liệu người dùng</p>';
                return;
            }
            
            // Chuyển đổi object thành array và sắp xếp
            const rankedUsers = Object.values(userStats).sort((a, b) => {
                const scoreA = a.vocab.mastered * 3 + a.vocab.known * 2 + a.vocab.learning;
                const scoreB = b.vocab.mastered * 3 + b.vocab.known * 2 + b.vocab.learning;
                return scoreB - scoreA;
            });
            
            // Giới hạn top 10 nếu có quá nhiều
            const displayUsers = rankedUsers.slice(0, 10);
            
            if (displayUsers.length === 0) {
                document.getElementById('user-ranking-table').innerHTML = '<p>Không có dữ liệu người dùng</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Hạng</th>
                            <th>Người dùng</th>
                            <th>Tổng từ</th>
                            <th>Đang học</th>
                            <th>Đã biết</th>
                            <th>Đã thuộc</th>
                            <th>Điểm</th>
                            <th>Mức độ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            displayUsers.forEach((userStat, index) => {
                const user = userStat.userInfo;
                const vocab = userStat.vocab;
                const score = vocab.mastered * 3 + vocab.known * 2 + vocab.learning;
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${user.name || 'Không tên'} (${user.email})</td>
                        <td>${vocab.total}</td>
                        <td>${vocab.learning}</td>
                        <td>${vocab.known}</td>
                        <td>${vocab.mastered}</td>
                        <td><strong>${score}</strong></td>
                        <td><span class="status-badge ${getLevelClass(userStat.activityLevel)}">${userStat.activityLevel}</span></td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            document.getElementById('user-ranking-table').innerHTML = tableHTML;
        }

        // Tạo danh sách chi tiết người dùng
        function createUserDetailsList() {
            const userStats = analyticsData.userStats;
            if (!userStats) {
                document.getElementById('user-details-list').innerHTML = '<p>Không có dữ liệu người dùng</p>';
                return;
            }
            
            let detailsHTML = '';
            const userFilter = document.getElementById('analytics-user-filter').value;
            
            // Nếu đang filter theo 1 người dùng, chỉ hiển thị người đó
            if (userFilter && userFilter !== 'top-10') {
                const userStat = userStats[userFilter];
                if (userStat) {
                    detailsHTML = createUserDetailCard(userStat);
                }
            } else {
                // Hiển thị tất cả người dùng
                const userArray = Object.values(userStats);
                userArray.forEach(userStat => {
                    detailsHTML += createUserDetailCard(userStat);
                });
            }
            
            document.getElementById('user-details-list').innerHTML = detailsHTML || '<p>Không có dữ liệu người dùng</p>';
        }

        // Tạo card chi tiết cho một người dùng
        function createUserDetailCard(userStat) {
            const user = userStat.userInfo;
            const vocab = userStat.vocab;
            const learnedTotal = userStat.learnedTotal;
            const masteredTotal = userStat.masteredTotal;
            const activityLevel = userStat.activityLevel;
            
            // Tính tỷ lệ phần trăm
            const masteredPercent = vocab.total > 0 ? Math.round((vocab.mastered / vocab.total) * 100) : 0;
            const knownPercent = vocab.total > 0 ? Math.round((vocab.known / vocab.total) * 100) : 0;
            
            return `
                <div class="card">
                    <h3>${user.name || 'Không tên'} (${user.email}) 
                        <span class="status-badge ${getLevelClass(activityLevel)}">${activityLevel}</span>
                    </h3>
                    <div class="progress-summary">
                        <div class="progress-item">
                            <div class="label">Tổng từ vựng</div>
                            <div class="value">${vocab.total}</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Đang học</div>
                            <div class="value">${vocab.learning}</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Đã biết</div>
                            <div class="value">${vocab.known} (${knownPercent}%)</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Đã thuộc</div>
                            <div class="value">${vocab.mastered} (${masteredPercent}%)</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-info view-user-vocab" data-userid="${user.id}">Xem từ vựng</button>
                    </div>
                </div>
            `;
        }

        // Lấy class CSS cho mức độ
        function getLevelClass(level) {
            switch(level) {
                case 'Xuất sắc': return 'status-mastered';
                case 'Tích cực': return 'status-known';
                case 'Trung bình': return 'status-learning';
                case 'Bắt đầu': return '';
                case 'Không hoạt động': return '';
                default: return '';
            }
        }

        // Tạo biểu đồ
        function createCharts() {
            // Hủy biểu đồ cũ nếu có
            if (overallProgressChart) {
                overallProgressChart.destroy();
            }
            if (userDistributionChart) {
                userDistributionChart.destroy();
            }
            
            // Biểu đồ tiến độ tổng hợp
            const overallCtx = document.getElementById('overall-progress-chart').getContext('2d');
            overallProgressChart = new Chart(overallCtx, {
                type: 'line',
                data: {
                    labels: analyticsData.dailyData.labels || [],
                    datasets: [
                        {
                            label: 'Từ đã học (tất cả người dùng)',
                            data: analyticsData.dailyData.learnedData || [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Từ đã thuộc (tất cả người dùng)',
                            data: analyticsData.dailyData.masteredData || [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // Biểu đồ phân phối người dùng
            const distributionCtx = document.getElementById('user-distribution-chart').getContext('2d');
            userDistributionChart = new Chart(distributionCtx, {
                type: 'pie',
                data: {
                    labels: ['Bắt đầu (0-10 từ)', 'Trung bình (11-50 từ)', 'Tích cực (51-200 từ)', 'Xuất sắc (201+ từ)'],
                    datasets: [{
                        data: [
                            analyticsData.userGroups?.beginner || 0,
                            analyticsData.userGroups?.intermediate || 0,
                            analyticsData.userGroups?.advanced || 0,
                            analyticsData.userGroups?.expert || 0
                        ],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0'
                        ],
                        hoverBackgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} người dùng (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Đánh giá tổng thể hệ thống
        function evaluateOverallProgress() {
            const evaluationElement = document.getElementById('overall-evaluation');
            evaluationElement.className = 'evaluation';
            
            if (!analyticsData.activeUsers || analyticsData.activeUsers === 0) {
                evaluationElement.innerHTML = `
                    <h3>Chưa có hoạt động học tập</h3>
                    <p>Hệ thống chưa có người dùng nào có hoạt động học tập.</p>
                `;
                return;
            }
            
            const avgWordsPerUser = Math.round((analyticsData.totalLearned + analyticsData.totalMastered) / analyticsData.activeUsers);
            const totalUsers = analyticsData.totalUsers;
            const activeRate = Math.round((analyticsData.activeUsers / totalUsers) * 100);
            
            let evaluationText = '';
            let evaluationClass = '';
            
            if (avgWordsPerUser >= 50) {
                evaluationText = 'Xuất sắc!';
                evaluationClass = 'excellent';
                evaluationElement.innerHTML = `
                    <h3>${evaluationText}</h3>
                    <p>Hệ thống hoạt động rất tốt! Trung bình mỗi người dùng đã học ${avgWordsPerUser} từ.</p>
                    <p>Tỷ lệ người dùng hoạt động: ${activeRate}% (${analyticsData.activeUsers}/${totalUsers})</p>
                `;
            } else if (avgWordsPerUser >= 20) {
                evaluationText = 'Tốt!';
                evaluationClass = 'good';
                evaluationElement.innerHTML = `
                    <h3>${evaluationText}</h3>
                    <p>Hệ thống hoạt động tốt. Trung bình mỗi người dùng đã học ${avgWordsPerUser} từ.</p>
                    <p>Tỷ lệ người dùng hoạt động: ${activeRate}% (${analyticsData.activeUsers}/${totalUsers})</p>
                `;
            } else if (avgWordsPerUser >= 5) {
                evaluationText = 'Khá';
                evaluationClass = 'average';
                evaluationElement.innerHTML = `
                    <h3>${evaluationText}</h3>
                    <p>Hệ thống hoạt động khá. Trung bình mỗi người dùng đã học ${avgWordsPerUser} từ.</p>
                    <p>Tỷ lệ người dùng hoạt động: ${activeRate}% (${analyticsData.activeUsers}/${totalUsers})</p>
                    <p>Hãy khuyến khích người dùng học thêm từ mới!</p>
                `;
            } else {
                evaluationText = 'Cần cải thiện';
                evaluationClass = 'poor';
                evaluationElement.innerHTML = `
                    <h3>${evaluationText}</h3>
                    <p>Hệ thống cần được cải thiện. Trung bình mỗi người dùng chỉ học được ${avgWordsPerUser} từ.</p>
                    <p>Tỷ lệ người dùng hoạt động: ${activeRate}% (${analyticsData.activeUsers}/${totalUsers})</p>
                    <p>Cần có biện pháp thu hút và khuyến khích người dùng học tập nhiều hơn!</p>
                `;
            }
            
            evaluationElement.classList.add(evaluationClass);
        }

        // Setup analytics filters - ĐƠN GIẢN CHỈ CÓ SELECT BOX
        document.getElementById('analytics-user-filter').addEventListener('change', () => {
            const userId = document.getElementById('analytics-user-filter').value;
            
            // Xử lý các option đặc biệt
            if (userId === 'top-10') {
                loadAnalyticsData('top-10');
            } else {
                loadAnalyticsData(userId || null);
            }
        });

        // Thêm sự kiện cho nút xem từ vựng trong chi tiết người dùng
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-user-vocab')) {
                const userId = e.target.getAttribute('data-userid');
                // Chuyển sang tab từ vựng và lọc theo người dùng
                document.querySelector('[data-tab="vocabulary"]').click();
                document.getElementById('vocab-user-filter').value = userId;
                loadUserVocabulary(userId);
                
                // Tìm tên người dùng
                const userStat = analyticsData.userStats?.[userId];
                const userName = userStat ? (userStat.userInfo.name || userStat.userInfo.email) : userId;
                showAlert(`Đang hiển thị từ vựng của: ${userName}`, 'success');
            }
        });

        // Setup vocabulary filters
        document.getElementById('vocab-user-filter').addEventListener('change', () => {
            currentPage = 1;
            const userId = document.getElementById('vocab-user-filter').value;
            loadUserVocabulary(userId || null);
        });
        
        document.getElementById('vocab-status-filter').addEventListener('change', () => {
            currentPage = 1;
            applyFiltersAndDisplay();
        });
        
        document.getElementById('vocab-search').addEventListener('input', () => {
            currentPage = 1;
            // Không load lại ngay, chỉ khi người dùng dừng gõ
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                applyFiltersAndDisplay();
            }, 500);
        });

        // Nút làm mới trong tab từ vựng
        document.getElementById('refresh-vocab').addEventListener('click', () => {
            currentPage = 1;
            const userId = document.getElementById('vocab-user-filter').value;
            loadUserVocabulary(userId || null);
        });

        // Close modal
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('vocab-modal').style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('vocab-modal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Show alert message
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            // Insert after tabs
            const tabs = document.querySelector('.tabs');
            tabs.parentNode.insertBefore(alert, tabs.nextSibling);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Logout
        document.getElementById('logout').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>
